---
title: "Legislativas 2025"
format: 
  dashboard:
    orientation: rows
    theme: cosmo
---

```{ojs}
//| label: 1-setup-completo
//| output: false

d3 = require("d3@7")
L = require("leaflet@1.9.4")
html`<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>`

partyColors = {
  return {
    "PS": "#e41a1c", "AD": "#ff7f00", "PPD/PSD.CDS-PP": "#ff7f00", 
    "CH": "#1e53a1ff", "IL": "#2ebce7ff", "B.E.": "#984ea3", 
    "L": "#4daf4a", "PCP-PEV": "#1a9850", "PAN": "#00a6a6",
    "R.I.R.": "#f781bf", "VP": "#a6cee3", "ADN": "#fdbf6f", 
    "E": "#ffed6f", "JPP": "#cab2d6", "MPT": "#b2df8a", 
    "NC": "#6a3d9a", "ND": "#fb9a99", "PLS": "#ffff99", 
    "PPM": "#1f78b4", "PCTP/MRPP": "#e31a1c", "PTP": "#a6cee3"
  };
}

getColor = function(p) { return partyColors[p] || "#999"; }
normalize = function(t) { return t ? t.toUpperCase().trim() : ""; }

resultados = FileAttachment("data/resultados.json").json().catch(e => null)
distritosGeo = FileAttachment("data/ContinenteDistritos_geo.geojson").json().catch(e => null)

dadosOK = (resultados && distritosGeo && resultados.Inscritos) ? true : false

distritos = dadosOK 
  ? Object.keys(resultados.Inscritos).filter(d => d !== "Total") 
  : ["Aguardando..."]

partidos = dadosOK 
  ? Object.keys(resultados).filter(k => !["Inscritos", "Votantes", "Brancos", "Nulos", "VVE"].includes(k)) 
  : ["PS", "PSD"]

winners = {
  const w = {};
  if (!dadosOK) return w;
  
  for (const dist of distritos) {
    let bestP = "N/A";
    let bestV = -1;
    for (const p of partidos) {
      if (resultados[p]) {
        const val = resultados[p][dist] || 0;
        if (val > bestV) { bestV = val; bestP = p; }
      }
    }
    w[dist] = { partido: bestP, votos: bestV };
  }
  return w;
}

winnersNorm = Object.fromEntries(Object.entries(winners).map(([d, i]) => [normalize(d), i]))

partidoMaisVotadoNacional = {
  if (!dadosOK) return { partido: "...", votos: 0 };
  
  const votosNacionais = partidos.map(p => ({
    partido: p,
    votos: (resultados[p] || {})["Total"] || 0
  }));
  
  return votosNacionais.length > 0
    ? votosNacionais.reduce((a, b) => b.votos > a.votos ? b : a)
    : { partido: "...", votos: 0 };
}

abstNacional = dadosOK 
  ? (100 - (resultados.Votantes.Total / resultados.Inscritos.Total * 100)) 
  : 0

```

# {.sidebar}
```{ojs}
viewof distritoSelecionado = Inputs.select(distritos, {label: "Distrito:", value: distritos[0]})
viewof partidoIntensidade = Inputs.select(partidos, {label: "Partido (Mapa):", value: "PS"})

md`
---
**Status:** ${dadosOK ? "✅ Online" : "❌ A carregar..."}
`
```

# Visão Geral {height=20%}
```{ojs}
html`
<div style="display:flex; gap:1rem; height:100%; align-items: center; width: 100%;">
  
  <div style="flex:1; padding:15px; border-radius:10px; background:#f8f9fa; border-left: 5px solid #666;">
    <div style="font-size:0.9rem; color:#666; font-weight:bold;">ABSTENÇÃO</div>
    <div style="font-size:2rem; font-weight:bold;">${abstNacional.toFixed(1)}%</div>
  </div>

  <div style="flex:1; padding:15px; border-radius:10px; background:#e3f2fd; border-left: 5px solid ${getColor(partidoMaisVotadoNacional.partido)};">
    <div style="font-size:0.9rem; color:#666; font-weight:bold;">VENCEDOR NACIONAL</div>
    <div style="font-size:2rem; font-weight:bold;">${partidoMaisVotadoNacional.partido}</div>
    <div style="font-size:0.8rem;">${partidoMaisVotadoNacional.votos.toLocaleString("pt-PT")} votos</div>
  </div>

</div>
`
```

# Mapas {height=45%}
## Column {width=50%}
```{ojs}
mapaVencedor = {
  const div = document.createElement("div");
  div.style.height = "500px"; 
  div.style.width = "100%";
  div.style.zIndex = "1";
  
  if (!dadosOK) { 
    div.innerHTML = "<div style='padding:20px'>⚠️ A carregar dados...</div>"; 
    return div; 
  }

  const map = L.map(div).setView([39.6, -8], 6);
  
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  function style(feature) {
    const props = feature.properties;
    const nomeRaw = props.DISTRITO || props.Distrito || props.NOME || props.name || props.NAME_1 || props.NAME_0 || "Desconhecido";
    
    const nome = normalize(nomeRaw);
    const info = winnersNorm[nome];
    
    const corFinal = info ? getColor(info.partido) : "#ff00ff";

    return { 
      color: "#555", 
      weight: 1, 
      fillOpacity: 0.7, 
      fillColor: corFinal 
    };
  }
  
  function onEachFeature(feature, layer) {
    const props = feature.properties;
    const nomeRaw = props.DISTRITO || props.Distrito || props.NOME || props.name || props.NAME_1 || "Desconhecido";
    const nome = normalize(nomeRaw);
    const info = winnersNorm[nome] || { partido: "Sem dados", votos: 0 };
    
    layer.bindTooltip(`
      <div style='font-family:sans-serif'>
        <strong>${nomeRaw}</strong><br>
        Vencedor: ${info.partido}<br>
        Votos: ${info.votos.toLocaleString()}
      </div>
    `);
  }

  if (distritosGeo && distritosGeo.features) {
     const geoLayer = L.geoJSON(distritosGeo, { style, onEachFeature }).addTo(map);
  }
  
  setTimeout(() => map.invalidateSize(), 500);
  return div;
}
```

## Column {width=50%}
```{ojs}
mapaIntensidade = {
  const div = document.createElement("div");
  div.style.height = "500px"; 
  div.style.width = "100%";
  div.style.zIndex = "1";

  if (!dadosOK) { 
    div.innerHTML = "⚠️ A carregar dados..."; 
    return div; 
  }

  const map = L.map(div).setView([39.6, -8], 6);
  
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  function style(feature) {
    const props = feature.properties;
    const raw = props.DISTRITO || props.Distrito || props.NOME || props.name || props.NAME_1 || "Desconhecido";
    const match = distritos.find(d => normalize(d) === normalize(raw)) || raw;
    
    const pData = resultados[partidoIntensidade] || {};
    const votos = pData[match] || 0;
    const total = (resultados["VVE"] || {})[match] || 1;
    
    let ratio = (votos / total) * 3;
    const opacidade = Math.min(0.9, Math.max(0.2, ratio));
    
    return { 
      color: "#555", 
      weight: 1, 
      fillColor: getColor(partidoIntensidade), 
      fillOpacity: opacidade 
    };
  }
  
  function onEachFeature(feature, layer) {
    const props = feature.properties;
    const raw = props.DISTRITO || props.Distrito || props.NOME || props.name || "Desconhecido";
    const match = distritos.find(d => normalize(d) === normalize(raw)) || raw;
    
    const pData = resultados[partidoIntensidade] || {};
    const votos = pData[match] || 0;
    const total = (resultados["VVE"] || {})[match] || 1;
    const perc = (votos / total * 100).toFixed(1);
    
    layer.bindTooltip(`
      <div style='font-family:sans-serif'>
        <strong>${match}</strong><br>
        ${partidoIntensidade}: ${votos.toLocaleString()} votos<br>
        (${perc}%)
      </div>
    `);
  }

  if (distritosGeo && distritosGeo.features) {
    const geoLayer = L.geoJSON(distritosGeo, { style, onEachFeature }).addTo(map);
  }
  
  setTimeout(() => map.invalidateSize(), 500);
  return div;
}
```

# Detalhes {height=35% .tabset}
```{ojs}
sunburst = {
  if (!dadosOK) return md`⚠️ A carregar dados...`;

  const width = 600;
  const radius = width / 2;

  const sunburstVotosNac = partidos.map(p => ({
    partido: p, 
    votos: (resultados[p] && resultados[p]["Total"]) ? +resultados[p]["Total"] : 0
  }));
  
  const total = sunburstVotosNac.reduce((acc, x) => acc + x.votos, 0);
  
  const grandes = sunburstVotosNac.filter(x => x.votos/total >= 0.015);
  const outros = sunburstVotosNac.filter(x => x.votos/total < 0.015);
  
  const data = {
    name: "Portugal",
    children: [
      ...grandes.map(p => ({
         name: p.partido, 
         color: getColor(p.partido),
         children: distritos.map(d => ({ 
             name: d, 
             value: (resultados[p.partido] && resultados[p.partido][d]) ? +resultados[p.partido][d] : 0 
         })).filter(c => c.value > 0)
      })),
      {
         name: "Outros", color: "#ccc",
         children: distritos.map(d => ({
           name: d, 
           value: outros.reduce((acc, p) => acc + ((resultados[p.partido] && resultados[p.partido][d]) ? +resultados[p.partido][d] : 0), 0)
         })).filter(c => c.value > 0)
      }
    ]
  };

  const root = d3.hierarchy(data)
      .sum(d => d.value)
      .sort((a, b) => b.value - a.value);

  d3.partition()
      .size([2 * Math.PI, radius]) 
    (root);

  const arc = d3.arc()
      .startAngle(d => d.x0)
      .endAngle(d => d.x1)
      .padAngle(0.005)
      .padRadius(radius / 2)
      .innerRadius(d => d.y0)
      .outerRadius(d => d.y1 - 1);

  const svg = d3.create("svg")
      .attr("viewBox", [-width / 2, -width / 2, width, width])
      .style("font", "10px sans-serif");

  const cell = svg.append("g")
    .selectAll("g")
    .data(root.descendants().slice(1))
    .join("g");

  cell.append("path")
      .attr("fill", d => { 
          let current = d;
          while (current.depth > 1) current = current.parent; 
          return current.data.color || "#ccc"; 
      })
      .attr("fill-opacity", d => d.children ? 0.8 : 0.6)
      .attr("d", arc)
      .attr("stroke", "white")
      .attr("stroke-width", "1px");

  cell.append("text")
      .attr("transform", d => {
          const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
          const y = (d.y0 + d.y1) / 2;
          return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
      })
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .style("opacity", d => (d.x1 - d.x0 > 0.05) ? 1 : 0) 
      .style("pointer-events", "none")
      .style("fill", "#fff")
      .style("font-weight", "bold")
      .style("text-shadow", "1px 1px 2px #000")
      .text(d => d.data.name);

  cell.append("title")
      .text(d => `${d.ancestors().map(d => d.data.name).reverse().join(" > ")}\n${Math.round(d.value).toLocaleString()} votos`);

  svg.append("text")
      .attr("text-anchor", "middle")
      .style("user-select", "none")
      .style("pointer-events", "none")
      .style("font-size", "14px")
      .style("font-weight", "bold")
      .text("Portugal");

  return svg.node();
}
```


```{ojs}
Inputs.table(
  partidos.map(p => ({
    Partido: p,
    Votos: (dadosOK && resultados[p]) ? (resultados[p][distritoSelecionado] || 0) : 0
  })), { sort: "Votos", reverse: true }
)
```


```{ojs}
Inputs.table(
  distritos.map(d => ({
    Distrito: d,
    Partido: winners[d] ? winners[d].partido : "N/A",
    Votos: winners[d] ? winners[d].votos : 0
  })), { sort: "Votos", reverse: true }
)
```